---
title: "Interactive Graphic Example - Covid-19 Vaccinations in Massachusetts"
author: "Chris Krenz"
date: "2023-03-08"
output: html_document
---

```{r setup}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
```


# Introduction
### Background

### Purpose

### Dataset: COVID-19 Vaccinations in the Massachusetts
 - Source: United States Centers for Disease Control and Prevention
 - URL: 
https://data.cdc.gov/Vaccinations/COVID-19-Vaccinations-in-the-United-States-County/8xkx-amqh
 - Downloaded: 3/8/2023
 
### Methods
 - Dependent Vars:
   - Vaccination counts overall and for each age group:
     - 5+
     - 12+
     - 18+
     - 65+
   - Note: Only age groups with available data for all doses are included.
   - Note: 5+ counts are used for total counts.
 - Independent Vars:
   - Date (Range: 12/13/2020 - 2/15/2023)
   - MMWR Week (Morbidity and Mortality Weekly Report) (52-53 per year)
   - County (includes all 14 MA counties and 'Unknown County')
     - Note: Counties are also identified by the FIPS code (Federal Information Processing Standard).
   - Metro Status (Metro or Non-Metro)
   - SVI_CTGY: CDC Social Vulnerability Index (SVI) Rank
     - A: 0–0.25 SVI rank
     - B: 0.2501–0.50 SVI rank
     - C: 0.5001–0.75 SVI rank
     - D: 0.7501–1.0 SVI rank

See the data dictionary in doc/DataDictionary_v36_12082022.xlsx for additional information.


### R: Importing...
```{r importing}
c19vacsMA_raw <- read_csv("data/COVID-19_Vaccinations_MA_County.csv",
                    skip = 1,   # source URL
                    na = c("UNK", ""),    # only FIPS contains 'UNK'
                    col_types = cols(Date = col_date("%m/%d/%Y")))

problems(c19vacsMA_raw) # No problems (3/8/2023)

c19vacsMA_raw
```


### R: Tidying...
```{r tidying}
# Selecting cols
c19vacsMA_sel <- c19vacsMA_raw %>% 
  select(Date, MMWR_week, Recip_County, Metro_status, SVI_CTGY,
         # matches("^(Census2019_).*(5Plus|12Plus|18Plus|65Plus)"),
         matches(paste0("^(Census2019_|",
                          "Administered_Dose1_|", # all doses but second boost
                          "Series_Complete_|",
                          "Booster_Doses_|",
                          #"Second_Booster_|",
                          "Bivalent_Booster_)",
                       ".*(5Plus|12Plus|18Plus|65Plus|Pct)")))
## c19vacsMA_sel <- c19vacsMA_sel %>%
##   mutate("Yr-Wk" = paste0("`", substr(year(Date), 3, 4), "-", MMWR_week))

# Renaming SVI vals and col names
c19vacsMA_sel$SVI_CTGY[c19vacsMA_sel$SVI_CTGY == "A"] <- "0.00-0.25"
c19vacsMA_sel$SVI_CTGY[c19vacsMA_sel$SVI_CTGY == "B"] <- "0.25-0.50"
c19vacsMA_sel$SVI_CTGY[c19vacsMA_sel$SVI_CTGY == "C"] <- "0.50-0.75"
c19vacsMA_sel$SVI_CTGY[c19vacsMA_sel$SVI_CTGY == "D"] <- "0.75-1.00"
c19vacsMA_sel <- rename(c19vacsMA_sel, 
       "Week"   = "MMWR_week", 
       "County" = "Recip_County", 
       "Metro"  = "Metro_status", 
       "SVI"    = "SVI_CTGY")
c19vacsMA_sel$County <- str_replace(c19vacsMA_sel$County, " County", "")

c19vacsMA_sel


# Pivoting (longer) to consolidate various dosages and age groups to 2 cols
c19vacsMA_piv <- c19vacsMA_sel %>% 
  pivot_longer(cols = Administered_Dose1_Pop_Pct:Bivalent_Booster_65Plus, 
                 names_pattern = paste0(
                   ".*(Dose1|Series|Booster_Doses|Bivalent)",
                   ".*((?<!6)5Plus|12Plus|18Plus|65Plus)$"), # (?<!) look-behind
                 names_to = c("Dose", "Age"), # 1st term matches 1st regex group
                 values_to = "Count") #%>% 
  # pivot_longer(cols = matches("(_Pct)$"), names_pattern = paste0)

# Renaming vals of new Dose and Age cols
c19vacsMA_piv$Dose[c19vacsMA_piv$Dose == "Dose1"]         <- "First"
c19vacsMA_piv$Dose[c19vacsMA_piv$Dose == "Series"]        <- "Second"
c19vacsMA_piv$Dose[c19vacsMA_piv$Dose == "Booster_Doses"] <- "Booster"
c19vacsMA_piv$Age <- str_replace(c19vacsMA_piv$Age, "Plus", "+")

# Pivoting (wider) to extract the total pop for each age (to then calc percents)
# (consider also coalesce + replace for selectively pivoting wider...)
# c19vacsMA_piv <- c19vacsMA_piv %>% 
#   mutate(Pop = case_when(Age == "5+"  ~ Census2019_5PlusPop,
#                          Age == "12+" ~ Census2019_12PlusPop,
#                          Age == "18+" ~ Census2019_18PlusPop,
#                          Age == "65+" ~ Census2019_65PlusPop)) %>% 
#   select(-starts_with("Census"))

c19vacsMA_piv

#TODO: Why exactly no overall data for bivalent? Assumed to be 5yo+?
#TODO: Why exactly is there so little data on Second_Booster?
```


### R: Analyzing...
```{r analyzing}
c19vacsMA_per <- c19vacsMA_piv %>% 
  # mutate(Percentage = ifelse((Count/Pop) <= 0.95, (Count/Pop), 0.95))
  mutate(Percentage = Count/Pop)
  c19vacsMA_per$Percentage[c19vacsMA_per$Percentage > 0.95] <- 0.95
# NOTE: The CDC caps the percentage estimates at 95% (otherwise, some values are over 100%), so I am doing the same here.
  
c19vacsMA_per %>% 
  filter(Dose == "First", County == "Suffolk", Age == "65+", format(Date, "%Y") == "2021")


```


### R: Plotting...
```{r plotting}
plot_spacing <- theme(plot.margin = unit(c(1, 1, 1, 1), "cm"), 
                      plot.title = element_text(hjust = 0.5, vjust = 5), 
                      legend.title.align = 0.5, 
                      axis.title.x = element_text(vjust = -5), 
                      axis.title.y = element_text(vjust = 5))

c19vacsMA_per %>%
  filter(Dose == "First", County == "Suffolk", Age == "65+", format(Date, "%Y") == "2021") %>% 
  
  ggplot(aes(Week, Percentage, color = Age)) +
  geom_point(alpha = 0.5) +
  labs(title = 
         expression("Percentage of age groups with" ~bolditalic("at least")* 
                    " one vaccine dose (by county)"),
       x = "MMWR Week", y = "Pop/Age Group Percentage", color = "Age Group") +
  # scale_color_discrete(breaks = c('65+', '18+', '12+', '5+')) +
  scale_color_manual(breaks = c('65+', '18+',    '12+',   '5+'), 
                     values = c("red", "orange", "green", "blue")) +
  plot_spacing

# TODO: Change to percentages and then change labels
# TODO: Filters working properly?
```


# Conclusion
### Discussion

### References

### Notes

### Credits

